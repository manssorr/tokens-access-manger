name: Deploy Backend to Render

on:
  push:
    branches:
      - main
    paths:
      - 'server/**'
      - 'shared/**'
      - '.github/workflows/deploy-backend.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Check Deploy Hook Secret
        run: |
          if [ -z "${{ secrets.RENDER_DEPLOY_HOOK_BACKEND }}" ]; then
            echo "‚ùå ERROR: RENDER_DEPLOY_HOOK_BACKEND secret is not set"
            echo ""
            echo "üìù Setup Instructions:"
            echo "1. Go to Render Dashboard ‚Üí Your Backend Web Service ‚Üí Settings"
            echo "2. Copy the Deploy Hook URL"
            echo "3. Go to GitHub Repo ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "4. Add secret: RENDER_DEPLOY_HOOK_BACKEND with the deploy hook URL"
            echo ""
            echo "For detailed instructions, see: .github/workflows/README.md"
            exit 1
          fi

      - name: Trigger Render Deployment
        run: |
          echo "üöÄ Triggering backend deployment to Render..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.RENDER_DEPLOY_HOOK_BACKEND }}")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)

          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
            echo "‚úÖ Deployment triggered successfully (HTTP $HTTP_CODE)"
          else
            echo "‚ùå Deployment failed (HTTP $HTTP_CODE)"
            echo "$RESPONSE"
            exit 1
          fi
